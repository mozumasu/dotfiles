#!/usr/bin/env zsh
# nb add article - Add a note with article title and URL
# Usage: nba <url>              - Auto-fetch title from URL
#        nba <title> <url>      - Use specified title
# Example: nba "https://zenn.dev/sora_kumo/articles/prisma-7-rust-free"

if [ $# -lt 1 ]; then
  echo "Usage: nba <url>           # Auto-fetch title"
  echo "       nba <title> <url>   # Manual title"
  return 1
fi

local title=""
local url=""

if [ $# -eq 1 ]; then
  # Auto-fetch title from URL
  url="$1"
  echo "Fetching title from: $url"

  # Determine fetch size based on domain (Zenn/Qiita have title early)
  local fetch_size=3072
  if [[ "$url" =~ ^https?://(zenn\.dev|qiita\.com)/ ]]; then
    fetch_size=512
  fi

  title=$(curl -sL --max-time 10 "$url" | head -c $fetch_size | perl -0777 -ne 'print $1 if /<title[^>]*>([^<]+)<\/title>/i')
  # Clean up title (remove extra whitespace and newlines)
  title=$(echo "$title" | perl -pe 's/^\s+|\s+$//g; s/\s+/ /g')

  if [ -z "$title" ]; then
    echo "Error: Could not fetch title from URL"
    return 1
  fi
  echo "Title: $title"
else
  # Use provided title and URL
  title="$1"
  url="$2"
fi

# Create note content
local content="# ${title}

参照: [${title}](${url})
"

# Add note using nb
echo "$content" | nb add --filename "${title}.md"

echo "Note created: [${title}](${url})"
