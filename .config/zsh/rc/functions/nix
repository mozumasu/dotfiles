#!/usr/bin/env zsh
# Suggest untracked files when nix command fails

command nix "$@"
local exit_code=$?
if [[ $exit_code -ne 0 ]]; then
  local untracked_files=()
  while IFS= read -r line; do
    [[ -n "$line" ]] && untracked_files+=("$line")
  done < <(git ls-files --others --exclude-standard)
  if [[ ${#untracked_files[@]} -gt 0 ]]; then
    local red yellow bold reset
    red="$(printf '\033[31m')"
    yellow="$(printf '\033[33m')"
    bold="$(printf '\033[1m')"
    reset="$(printf '\033[0m')"
    echo ""
    echo "${red}${bold}nix command failed!${reset}"
    echo "${yellow}Did you forget to ${bold}git add${reset} ${yellow}these new files?${reset}"
    for file in "${untracked_files[@]}"; do
      if [[ "$file" == *.nix ]]; then
        echo "  ${bold}$file${reset}"
      else
        echo "  $file"
      fi
    done
  fi
fi
return $exit_code
