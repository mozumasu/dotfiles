#!/usr/bin/env zsh

# WorkSpaces 情報取得
local workspaces
workspaces=$(aws workspaces describe-workspaces \
    --query "Workspaces[*].[WorkspaceId, UserName, IpAddress, DirectoryId]" \
    --output text)

# SSM インスタンス情報取得
local ssm_info
ssm_info=$(aws ssm describe-instance-information \
    --query "InstanceInformationList[*].[InstanceId, IPAddress]" \
    --output text)

# ヘッダー出力
echo -e "WorkspaceId\tUserName\tPrivateIP\tPublicIP\tDirectoryId\tInstanceId" | column -t

# 各 WorkSpace を処理
while read -r workspace_id username private_ip directory_id; do
    public_ip="None"
    instance_id="not found"

    # ENI から Public IP を取得（存在する場合）
    if [ "$private_ip" != "None" ]; then
        public_ip=$(aws ec2 describe-network-interfaces \
            --filters "Name=private-ip-address,Values=$private_ip" \
            --query "NetworkInterfaces[0].Association.PublicIp" \
            --output text 2>/dev/null)

        [ "$public_ip" = "None" ] && public_ip="None"

        # IP で SSM インスタンスを突き合わせて InstanceId を取得
        while read -r ssm_instance_id ssm_ip; do
            if [ "$private_ip" = "$ssm_ip" ]; then
                instance_id="$ssm_instance_id"
                break
            fi
        done <<< "$ssm_info"
    fi

    echo -e "$workspace_id\t$username\t$private_ip\t$public_ip\t$directory_id\t$instance_id" | column -t
done <<< "$workspaces"
