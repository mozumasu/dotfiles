#!/usr/bin/env zsh

local local_file="$1"
local region="${2:-ap-northeast-1}" # default region
local temp_aws_file="/tmp/ssm_document.yml"

if [[ -z "$local_file" ]]; then
  echo "Usage: sync_ssm_document <local_file> [region]"
  return 1
fi

if [[ ! -f "$local_file" ]]; then
  echo "Error: Local file '$local_file' not found."
  return 1
fi

# 自分が作成したSSMドキュメント一覧を取得してfzfで選択
local document_name
document_name=$(aws ssm list-documents \
  --region "$region" \
  --filters Key=Owner,Values=Self \
  --query "DocumentIdentifiers[].Name" \
  --output json | jq -r '.[]' | fzf --prompt="Select SSM Document: ")

if [[ -z "$document_name" ]]; then
  echo "No SSM Document selected. Exiting."
  return 1
fi

echo "Selected SSM Document: $document_name"

# 確認プロンプト
echo "Are you sure you want to update the SSM Document '$document_name' with '$local_file'? (y/n)"
read -r confirmation
if [[ "$confirmation" != "y" ]]; then
  echo "Update canceled."
  return 0
fi

# AWS上のドキュメントを取得
aws ssm get-document \
  --name "$document_name" \
  --region "$region" \
  --query "Content" \
  --output text > "$temp_aws_file" 2>/dev/null

if [[ $? -ne 0 ]]; then
  echo "Error: Failed to retrieve content for SSM Document '$document_name'."
  return 1
fi

# ローカルファイルとAWSドキュメントを比較
if diff "$local_file" "$temp_aws_file" > /dev/null; then
  echo "No changes detected. SSM Document is up to date."
else
  echo "Changes detected. Updating SSM Document..."
  # 最新バージョン番号を取得
  local latest_version
  latest_version=$(aws ssm list-document-versions \
    --name "$document_name" \
    --region "$region" \
    --query "DocumentVersions[0].DocumentVersion" \
    --output text | head -n 1)

  # ドキュメントを更新
  if aws ssm update-document \
    --name "$document_name" \
    --content file://"$local_file" \
    --document-version "$latest_version" \
    --region "$region"; then

    # バージョン番号を整数として扱い、1を加算
    latest_version=$((latest_version + 1))

    echo "SSM Document '$document_name' updated successfully to version $latest_version."
  else
    echo "SSM Document update failed."
  fi
  echo "Updating default version to $latest_version..."
  # デフォルトバージョンを最新に更新
  aws ssm update-document-default-version \
    --name "$document_name" \
    --document-version "$latest_version" \
    --region "$region"
fi

# 一時ファイルを削除
rm -f "$temp_aws_file"
