snippets:
  - keyword: AP;
    snippet: AWS_PROFILE=

  - keyword: awsl
    snippet: aws configure list

  - keyword: ic;
    snippet: aws ec2-instance-connect ssh --instance-id {{instance-id}} --os-user ec2-user

  - keyword: icu;
    snippet: aws ec2-instance-connect ssh --instance-id {{instance-id}} --os-user {{ec2-user}}

  - keyword: smg;
    snippet: aws secretsmanager get-secret-value --secret-id {{env-HogePassword}} --query SecretString --output text

  - keyword: awsv
    snippet: aws-vault

  - keyword: etr;
    snippet:
      aws ecs run-task \
        --cluster {{EcsCluster}} \
        --task-definition {{TaskDefinition}} \
        --launch-type FARGATE \
        --network-configuration "awsvpcConfiguration={subnets=[{{SubnetId}}],securityGroups=[{{SecurityGroupId}}],assignPublicIp=DISABLED}"

  - keyword: cfls
    snippet:
      aws cloudformation describe-stacks --profile {{aws-profile}} --query 'Stacks[?contains(StackName,`prod-`)].[StackName,StackStatus]' --output table

  - keyword: cdkls
    snippet: cdk list -c env=

  - keyword: iamlr
    snippet:
      aws iam list-roles
        --query 'Roles[?starts_with(RoleName, `{{prefix}}`)].RoleName'
        --output table

  - keyword: ssm;
    snippet: aws ssm start-session --target {{InstanceId}} --profile {{aws-profile}}

completions:
  - name: instance-id
    patterns:
      - "aws ec2-instance-connect ssh --instance-id( .*)?"
    sourceCommand: "aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId, Tags[?Key==`Name`].Value | [0]]' --output text"
    callback: "awk -F ' ' '{ print $1 }'"

  - name: aws profile
    patterns:
      - "aws-vault login( .*)? $"
      - '^aws\b.*--profile(?:(?:=|\s+)([A-Za-z0-9._-]*))?\s*$'
      - '^\s*AWS_PROFILE=[A-Za-z0-9._-]*$'
    sourceCommand: "aws configure list-profiles"
  # ECS
  - name: EcsCluster
    patterns:
    # right after the option, value not typed yet
    - '^.*--cluster(?:$|\\\s*)$'
    - '^.*--cluster\s+$'
    # while typing the value (until another -- option or a line continuation \ appears)
    - '^.*--cluster(?:=|\s+)(?=[^\s\\-])[^\\]*$'
    sourceCommand: aws ecs list-clusters | jq -r '.clusterArns[] | split("/")[-1]'

  - name: TaskDefinition
    patterns:
    # right after the option, value not typed yet
    - '^.*--task-definition(?:$|\\\s*)$'
    - '^.*--task-definition\s+$'
    # while typing the value (until another -- option or a line continuation \ appears)
    - '^.*--task-definition(?:=|\s+)(?=[^\s\\-])[^\\]*$'
    sourceCommand: aws ecs list-task-definitions --status ACTIVE --sort DESC | jq -r '.taskDefinitionArns[] | split("/")[-1]'

  - name: SubnetId
    patterns:
      - '^.*\bsubnets=\[[^\]]*$'
      - '^.*\bsubnet-[0-9a-f]*$'
      - '^.*--subnet-ids?\s+$'
      - '^.*--subnet-ids?(?:=|\s+)(?=[^\s\\-])[^\\]*$'
    sourceCommand: "aws ec2 describe-subnets --query 'Subnets[].[SubnetId, Tags[?Key==`Name`].Value | [0] || `(no name)`, AvailabilityZone]' --output text | perl -pe 's/\\t/ : /g'"
    callback: "awk '{ print $1 }'"

  - name: SecurityGroupId
    patterns:
      - '^.*securityGroups=\[[^\]]*$'
      - '^.*\bsg-[0-9a-f]*$'
      - '^.*--security-group-ids?\s+$'
      - '^.*--security-group-ids?(?:=|\s+)(?=[^\s\\-])[^\\]*$'
    sourceCommand: "aws ec2 describe-security-groups --query 'SecurityGroups[].[GroupId, GroupName]' --output text | perl -pe 's/\\t/ : /g'"
    callback: "awk '{ print $1 }'"

  # VPC ID
  - name: VpcId
    patterns:
      - '^.*--vpc-ids?\s+$'
      - '^.*--vpc-ids?(?:=|\s+)(?=[^\s\\-])[^\\]*$'
      - '^.*\bvpc-[0-9a-f]*$'
    sourceCommand: "aws ec2 describe-vpcs --query 'Vpcs[].[VpcId, Tags[?Key==`Name`].Value | [0] || `(no name)`]' --output text | perl -pe 's/\\t/ : /g'"
    callback: "awk '{ print $1 }'"

  # EC2 Instance ID (汎用)
  - name: InstanceId
    patterns:
      - '^.*--instance-ids?\s+$'
      - '^.*--instance-ids?(?:=|\s+)(?=[^\s\\-])[^\\]*$'
      - '^.*\bi-[0-9a-f]+$'
      # SSM start-session --target
      - '^.*ssm\s+start-session\s+--target\s+$'
      - '^.*ssm\s+start-session\s+--target(?:=|\s+)(?=[^\s\\-])[^\\]*$'
    sourceCommand: "LINE=\"${LBUFFER}${RBUFFER}\"; OPTS=\"\"; P=$(echo \"$LINE\" | awk -F'--profile ' '{print $2}' | awk '{print $1}'); [ -n \"$P\" ] && OPTS=\"$OPTS --profile $P\"; R=$(echo \"$LINE\" | awk -F'--region ' '{print $2}' | awk '{print $1}'); [ -n \"$R\" ] && OPTS=\"$OPTS --region $R\"; [ -z \"$P\" ] && { P=$(echo \"$LINE\" | awk -F'AWS_PROFILE=' '{print $2}' | awk '{print $1}'); [ -n \"$P\" ] && OPTS=\"$OPTS --profile $P\"; }; eval \"aws ec2 describe-instances $OPTS --query 'Reservations[].Instances[].[InstanceId, Tags[?Key==\\`Name\\`].Value | [0] || \\`(no name)\\`, State.Name]' --output text\" | tr '\\t' ' : '"
    callback: "awk '{ print $1 }'"

  # Key Pair
  - name: KeyName
    patterns:
      - '^.*--key-name\s+$'
      - '^.*--key-name(?:=|\s+)(?=[^\s\\-])[^\\]*$'
    sourceCommand: aws ec2 describe-key-pairs --query 'KeyPairs[].KeyName' --output text | tr '\t' '\n'

  # EBS Volume
  - name: VolumeId
    patterns:
      - '^.*--volume-ids?\s+$'
      - '^.*--volume-ids?(?:=|\s+)(?=[^\s\\-])[^\\]*$'
      - '^.*\bvol-[0-9a-f]+$'
    sourceCommand: "aws ec2 describe-volumes --query 'Volumes[].[VolumeId, Tags[?Key==`Name`].Value | [0] || `(no name)`, State]' --output text | perl -pe 's/\\t/ : /g'"
    callback: "awk '{ print $1 }'"

  # AMI (自分のイメージのみ)
  - name: ImageId
    patterns:
      - '^.*--image-id\s+$'
      - '^.*--image-id(?:=|\s+)(?=[^\s\\-])[^\\]*$'
    sourceCommand: "aws ec2 describe-images --owners self --query 'Images[].[ImageId, Name]' --output text | perl -pe 's/\\t/ : /g'"
    callback: "awk '{ print $1 }'"

  # Launch Template
  - name: LaunchTemplateId
    patterns:
      - '^.*--launch-template-id\s+$'
      - '^.*--launch-template-id(?:=|\s+)(?=[^\s\\-])[^\\]*$'
    sourceCommand: "aws ec2 describe-launch-templates --query 'LaunchTemplates[].[LaunchTemplateId, LaunchTemplateName]' --output text | perl -pe 's/\\t/ : /g'"
    callback: "awk '{ print $1 }'"

  # Target Group ARN
  - name: TargetGroupArn
    patterns:
      - '^.*--target-group-arns?\s+$'
      - '^.*--target-group-arns?(?:=|\s+)(?=[^\s\\-])[^\\]*$'
    sourceCommand: "aws elbv2 describe-target-groups --query 'TargetGroups[].[TargetGroupArn, TargetGroupName]' --output text | perl -pe 's/\\t/ : /g'"
    callback: "awk '{ print $1 }'"

  # Load Balancer ARN
  - name: LoadBalancerArn
    patterns:
      - '^.*--load-balancer-arns?\s+$'
      - '^.*--load-balancer-arns?(?:=|\s+)(?=[^\s\\-])[^\\]*$'
    sourceCommand: "aws elbv2 describe-load-balancers --query 'LoadBalancers[].[LoadBalancerArn, LoadBalancerName]' --output text | perl -pe 's/\\t/ : /g'"
    callback: "awk '{ print $1 }'"

  - name: cloudformation stack name
    patterns:
    - 'aws cloudformation.*--stack-name'
    sourceCommand: aws cloudformation describe-stacks --query 'Stacks[].StackName' --output text | tr '\t' '\n'

  - name: aws cli completer
    patterns:
      - '^\s*(?:[A-Z_]+=\S+\s+)*aws(?:$|\s.*)$'
    sourceCommand: 'LINE="${LBUFFER}${RBUFFER}"; CLEAN=$(perl -pe "s/^\s*(?:[A-Z_]+=\S+\s+)+//" <<< "$LINE"); OFF=$((${#LINE}-${#CLEAN})); COMP_LINE="$CLEAN" COMP_POINT=$((${#LBUFFER}-OFF)) aws_completer 2>/dev/null'
    options:
      --prompt: "'aws > '"
